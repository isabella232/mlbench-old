{% extends 'main/base.html' %}

{% block content %}
<div id="nodes-list" class="card-deck"></div>
{% endblock %}
{% block scripts %}
<script id="card-template" type="text/x-jsrender">
    <div class="card w-25 node-card" style="max-width:40rem" id="card-<%>name%>">
        <div class="card-header <%if phase === 'Running'%>bg-success<%else phase === 'Pending'%>bg-warning<%else%>bg-danger<%/if%>">
            <span data-feather="server"></span><%>name%>
        </div>
        <div class="card-body list-group">
            <!--<div class="d-flex w-100 justify-content-between">
                <span class="mb-1">Labels: </span>
                <span><%>labels%></span>
            </div>-->
            <div class="d-flex w-100 justify-content-between">
                <span class="mb-1">Ip: </span>
                <span><%>ip%></span>
            </div>
            <div class="d-flex w-100 justify-content-between">
                <span class="mb-1">Phase: </span>
                <span><%>phase%></span>
            </div>
            <div class="d-flex w-100 justify-content-between">
                <svg width="600" height="600"></svg>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
    var PodMonitor = function(){
        this.nodes = {}
        this.nodeRefreshInterval = 1 * 1000;
        this.metricsRefreshInterval = 20 * 1000;
        this.renderInterval = 1 * 1000;

        this.updateNodes = function(){
            var nodes = this.nodes;
            $.getJSON("api/nodes", function(data){
                $.each(data, function(index, value){
                    if(!(value['name'] in nodes)){
                        nodes[value['name']] = {};
                    }

                    nodes[value['name']]['node_info'] = value;
                });
            });
        }

        this.updateMetrics = function(){
            var nodes = this.nodes;

            $.each(nodes, function(node, value){
                $.getJSON("api/metrics/" + node + "/", function(data){
                    if(!('node_metrics' in value)){
                        value['node_metrics'] = [];
                    }

                    value['node_metrics'].push({
                        'cpu_total': data['container_cpu_usage_seconds_total']['value'],
                        'cpu_user': data['container_cpu_user_seconds_total']['value'],
                        'cpu_system': data['container_cpu_system_seconds_total']['value'],
                        'memory': data['container_memory_usage_bytes']['value']})
                });
            });
        }

        this.renderNodes = function(){
            var nodes = this.nodes;
            var metricsRefreshInterval = this.metricsRefreshInterval;

            $("#nodes-list").empty();

            $.each(nodes, function(node, value){
                var card = $("#card-template").render(value['node_info']);
                $("#nodes-list").append(card)

                if(('node_metrics' in value)){

                    prev = [value['node_metrics'][0]['cpu_total']]
                    data = []

                    len = value['node_metrics'].length;

                    var max = 0;

                    for(var i = 0; i < len; i++){
                        cur = value['node_metrics'][i]['cpu_total'];
                        cur_val = (cur - prev) / metricsRefreshInterval;

                        if(cur_val > max){
                            max = cur_val;
                        }

                        data.push({x: i, y: cur_val});
                        prev = cur;
                    }

                    var svg = d3.select($("#card-" + node + " svg")[0]),
                        margin = {top: 20, right: 20, bottom: 30, left: 50},
                        width = +svg.attr("width") - margin.left - margin.right,
                        height = +svg.attr("height") - margin.top - margin.bottom,
                        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    var x = d3.scaleLinear().range([0, len]);
                    var y = d3.scaleLinear().range([max, 0]);

                    // define the line
                    var line = d3.line()
                        .x(function(d) { return x(d.x); })
                        .y(function(d) { return y(d.y); });

                    x.domain(data.map(function(d) { return d.x; }));
                    y.domain([0, d3.max(data, function(d) { return d.y; })]);

                    g.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x))
                        .select(".domain")
                        .remove();

                    g.append("g")
                        .call(d3.axisLeft(y))
                        .append("text")
                        .attr("fill", "#000")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", "0.71em")
                        .attr("text-anchor", "end")
                        .text("Price ($)");

                    g.append("path")
                        .datum(data)
                        .attr("fill", "none")
                        .attr("stroke", "steelblue")
                        .attr("stroke-linejoin", "round")
                        .attr("stroke-linecap", "round")
                        .attr("stroke-width", 1.5)
                        .attr("d", line);
                }
            });

            feather.replace();
        }

        this.updateNodes();
        setTimeout(this.updateMetrics, 1000);

        setInterval(this.updateNodes, this.nodeRefreshInterval);
        setInterval(this.updateMetrics, this.metricsRefreshInterval);
        setInterval(this.renderNodes, this.renderInterval);
    }

    $(document).ready(function () {
        $.views.settings.delimiters("<%", "%>");

        var monitor = PodMonitor();
    })
</script>
{% endblock %}